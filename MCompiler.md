## M Compiler Structure

'M' is my lower level systems language.

The name of the compiler is `MM` or `mm.exe`. It is a whole-program compiler, written in M, that converts M programs to x64 native code running under Windows ABI.
````
    Inputs             Intermediates                                                              Outputs
                                               A           B        C       D       (F)     E        
    Ext Libs      ───>───────────────────────────┐
    Source File   ─┬─> AST1 ─> AST2 ─┬─> AST3 ─┬─┴──> PCL ─┬─> MCL ─┬─> SS ─┬─> EXE Image ──┬───> EXE File
    Include Files ─┘                 │         │           │        │       │               └───> DLL File
    Strinclude    ───>───────────────┘         │           │        │       ├───────────────────> OBJ File
                                               │           │        │       └─> MCU ─┬─> MCB ───> ML/MX Files
                                               │           │        │                └─> MCX ───> (RUN native code) 
                                               │           │        ├───────────────────────────> ASM File
                                               │           │        └───────────────────────────> NASM File (Config option)
                                               │           ├────────────────────────────────────> (RUNP Interpret PCL)
                                               │           ├────────────────────────────────────> PCL Source File
                                               │           └────────────────────────────────────> C Source File (Config option)
                                               ├────────────────────────────────────────────────> MA File
                                               └────────────────────────────────────────────────> LIST/PROJ Files
````

#### Inputs
````
Source Files:     There is only ever one `.m` source file submitted to MM. This will usually be the lead module,
                  that also lists other modules of the project.
                  Sometimes, that one input it will be a `.ma` file that contains all source and support files.

Include Files     These are discovered only when parsing all the source files. They are handled by the lexer.

Strinclude Files: (Text files which become string constants.) These are loaded during type analysis.

External Libs:    Any DLL and ML libraries required by the program are listed in the lead module with other project info.
                  These are always dynamically linked, never statically (there is no linker anyway).
````
#### Intermediates
````
AST1          Plus Symbol Table ST, and type tables TT, are generated by the Parser

AST2          Has all name references resolved (language allows out of order definitions so needs this extra pass)

AST3          Has type info filled in, any conversions applied, and constant expressions reduced

PCL           The generated IL (sometimes called IR) instructions from the AST. PCL uses a separate library that provides
              an API to generate internal PCL representation, which can then be processed in multiple different ways.

MCL           A representation of the generated native code, in this case it is for x64.

SS            A set of data structures containing binary native code and data, organised into code and data
              segments and with reloc info

EXE Image     An internal representation of what will go into the EXE file.

MCU           The binary code/data/import/reloc info for my private executable format

MCB           MCU rendered to a flat data block, written out as an ML/MX file

MCX           MCU with allocations, imports and fixups done to make it ready to run
              in-memory.
````
#### Outputs
````
EXE           The Windows executable file format (PE+)

DLL           The Windows shared library format.

ML            My private shared library format which had taken over DLL tasks for a while.

MX            The same format, used to write a complete executable. (Needs RUNMX app to load and run.
              In this form it is believed to attract less attention from AV software)

EXP           Export files. These are under review, but when generating ML (it was done for DLL too), it also generated an
              import module, which I plan to do for both M and Q languages, which simplify using the library from an M or
              Q application. Just import that generated module.

ASM           x64 assembly source code, in a syntax used by my own assembler 'AA'.

NASM          NASM format x64 assembly source code.

OBJ           The single OBJ file produced represents the whole program. OBJ files allow M code to be statically linked with other
              languages, but require an external linker.

RUN           Not an output, the program is run immediately in memory without generating any executable file. This allows M to be used
              like a scripting language, running programs directly from source code.

RUNP          This interprets the PCL intermediate representation in memory without translation to native code.

PCL           A dump of the IL as textual source code. This can be processed by the separate PC application.

C             Single C source file represents the entire program. No headers are generated. No headers are used in the file.
              Not all M programs can be transpiled as some features are not supported. Requires 64-bit C compiler; some features need gcc extensions.

MA            A single-file amalgamation of all source and support files needed to build a program.
              It can be directly built by MM to make for a tidy way of distributing and building M applications from source.

LIST          A dump of the top-level symbols (functions, variables, types, macros, enums) used across the project. These and
              the PROJ option are used by my IDE

PROJ          A summary of modules and subprograms used by the project

````

#### Compiler Size and Presentation

The compiler is a single 300KB to 400KB EXE file depending on configuration. It is self-contained, and contains the sources for the language's standard library. So the whole installation is a single file, `mm.exe`.

It translates M source code to binary at speeds of at least 500K lines per seconds, generating code at around 5MB per second.

The smallest M compiler, minus std library, and with only an IL interpreter is about 220KB.

#### ML and MX Files

These were a by-product of problems I'd had with generating DLL files. They were due to be dropped but are being kept on as they have some interesting properties that could turn out to be useful. Basically they are much simpler (and I believe portable) versions of DLL and EXE files.
